import { useEffect, useRef, useState, forwardRef } from 'react';

const Diagram = forwardRef(({ focused = 0 }, ref) => {
  const svgRef = useRef(null);
  const animateMotionsRef = [useRef(null), [useRef(null), useRef(null), useRef(null)], useRef(null)]
  const [initialized, setInitialized] = useState(false);

  useEffect(() => {
    if (ref) ref.current = svgRef.current;
    svgRef.current.pauseAnimations();

    const unpauseAnimation = () => {
      if (svgRef.current) {
        const { bottom, height } = svgRef.current.getBoundingClientRect();
        if (bottom <= window.innerHeight - height) {
          svgRef.current.unpauseAnimations();
          setInitialized(true);
        } else {
          requestAnimationFrame(unpauseAnimation);
        }
      }
    };

    requestAnimationFrame(unpauseAnimation);
  }, []);

  useEffect(() => {
    handleHover(animateMotionsRef[focused])();
  }, [focused])

  const handleHover = (animateMotionRef) => {
    const animateMotionRefs = animateMotionRef.forEach ? animateMotionRef : [animateMotionRef];

    return () => {
      if (initialized) {
        animateMotionRefs.forEach((ref) => {
          ref.current.beginElement();
        });
      }
    };
  };

  return (
    <svg ref={svgRef} width="100%" height="auto" viewBox="0 0 921 174" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        fill="black"
        d="M289.545,100.827a65.668,65.668,0,0,1-58.013,49.1q-2.814.24-5.692.242a65.73,65.73,0,0,1-63.705-49.342,1,1,0,1,1,1.938-.494,63.73,63.73,0,0,0,61.767,47.836q2.79,0,5.521-.235a63.544,63.544,0,0,0,37.37-16.313l-12.115-12.61a46.179,46.179,0,0,1-55.583,4.949,1,1,0,1,1,1.067-1.691A43.891,43.891,0,0,0,224.382,129V111.606a26.839,26.839,0,0,1-21.661-40.372,1,1,0,1,1,1.72,1.019,24.823,24.823,0,0,0,33.97,33.97,1,1,0,0,1,1.02,1.721,26.6,26.6,0,0,1-13.049,3.7v17.364a44.161,44.161,0,0,0,29.589-12.123q1.407-1.331,2.671-2.75a44.174,44.174,0,0,0,5.7-50.737,1,1,0,1,1,1.748-.972,46.174,46.174,0,0,1-5.959,53.04q-.991,1.112-2.066,2.173l12.122,12.616a63.467,63.467,0,0,0,17.416-29.92,1,1,0,1,1,1.938.494ZM162.135,68.375a65.8,65.8,0,0,1,127.41,0,1,1,0,0,1-1.938.5,63.822,63.822,0,0,0-100.3-34.911l10.949,14.077a46.173,46.173,0,0,1,52.19-2.15,1,1,0,1,1-1.067,1.691,43.628,43.628,0,0,0-12.267-5.313l-4.136,16.961a26.848,26.848,0,0,1,15.782,39.386,1,1,0,1,1-1.72-1.02,24.594,24.594,0,0,0,3.418-11.99H237.276a11.9,11.9,0,1,1-.076-2h13.225a24.841,24.841,0,0,0-37.352-19.979,1,1,0,0,1-1.02-1.721,26.714,26.714,0,0,1,18.985-3.152L235.171,41.8a44.3,44.3,0,0,0-48.032,64.648,1,1,0,1,1-1.748.972,46.183,46.183,0,0,1,8.748-55.912q1.242-1.176,2.547-2.241L185.737,35.192A63.575,63.575,0,0,0,164.073,68.87a1,1,0,0,1-1.938-.5Zm73.153,16.683a9.906,9.906,0,1,0-9.906,9.907A9.906,9.906,0,0,0,235.288,85.058Z"
      />
      <rect
        fill="rgba(0,0,0,0)"
        x="162"
        y="0"
        width="128"
        height="170"
        onMouseEnter={handleHover(animateMotionsRef[0])}
      />
      <path
        fill="black"
        d="M498.788,61.61a4.058,4.058,0,0,0,1.23.2,3.93,3.93,0,0,0,1.83-.45l2.33-1.2-6.16,7.47a4.9,4.9,0,0,0,7.17,6.65L522.2,57.99a3.2,3.2,0,0,1,2.28-.88L540.5,56.5l-13.292,7.24a5.152,5.152,0,0,0,4.02,9.46l22.04-7.6a16.258,16.258,0,0,0,8.04-6.05l10.83-15.41-1.63-1.16L559.668,58.4a14.305,14.305,0,0,1-7.06,5.31l-22.04,7.6a3.153,3.153,0,0,1-2.46-5.79l20.31-11.17-23.89.75a5.1,5.1,0,0,0-3.72,1.44L503.8,72.84a2.9,2.9,0,0,1-4.24-3.93l16.69-20.23a10.542,10.542,0,0,1,6.15-3.56L545.028,41a25.533,25.533,0,0,0,12.219-5.509h0L555.908,34a23.89,23.89,0,0,1-11.22,5.02l-10.95,2-8.42-1.1a7.522,7.522,0,0,0-4.47.8l-3.73,1.96-.36.01a8.254,8.254,0,0,0-4.42,1.5L497.7,54.51a4.03,4.03,0,0,0-1.26,5.11A3.932,3.932,0,0,0,498.788,61.61Zm26.27-19.71,2.23.29-.47.09-5.03.21A5.459,5.459,0,0,1,525.058,41.9Zm-26.22,14.25,14.64-10.32a6.3,6.3,0,0,1,3.35-1.14l1.17-.05a12.515,12.515,0,0,0-3.28,2.75l-7.31,8.85-6.48,3.34a2.014,2.014,0,0,1-1.54.13,2.047,2.047,0,0,1-1.18-1A2.026,2.026,0,0,1,498.838,56.15ZM584,84h22.786v2H598.07v.019H556.326a34.311,34.311,0,0,1-68.592,0H446V86h-8.563V84H464v.019h25.72v1a32.31,32.31,0,1,0,64.62,0v-1H584Zm-4.383,11.816,1.966.366a60.6,60.6,0,0,1-117.733,5.767q-.7-2.409-1.21-4.912l1.96-.4c.324,1.611.718,3.194,1.17,4.748h0a58.6,58.6,0,0,0,113.847-5.575Z"
      />
      <rect
        fill="rgba(0,0,0,0)"
        x="440"
        y="0"
        width="170"
        height="170"
        onMouseEnter={handleHover(animateMotionsRef[1])}
      />
      <path
        fill="black"
        d="m 836,0 c -46.9,0 -85,38.1 -85,85 0,46.9 38.1,85 85,85 32.5,0 60.79961,-18.29961 75.09961,-45.09961 0.3,0.1 0.60039,0.0996 0.90039,0.0996 2.8,0 5,-2.2 5,-5 0,-1.6 -0.70039,-3.00039 -1.90039,-3.90039 C 918.89961,106.49962 921,96 921,85 921,38.1 882.9,0 836,0 Z m 0,2 c 45.8,0 83,37.2 83,83 0,10.6 -1.99922,20.79922 -5.69922,30.19922 C 912.90078,115.09922 912.5,115 912,115 c -2.8,0 -5,2.2 -5,5 0,1.7 0.89922,3.19961 2.19922,4.09961 C 895.19922,150.19961 867.7,168 836,168 790.2,168 753,130.8 753,85 753,39.2 790.2,2 836,2 Z m 0,27 c -30.9,0 -56,25.1 -56,56 0,30.9 25.1,56 56,56 30.9,0 56,-25.1 56,-56 0,-30.9 -25.1,-56 -56,-56 z m 0,2 c 29.8,0 54,24.2 54,54 0,29.8 -24.2,54 -54,54 -29.8,0 -54,-24.2 -54,-54 0,-29.8 24.2,-54 54,-54 z m -10.16797,12.974609 c -0.65,0.0125 -1.30664,0.150782 -1.93164,0.425782 -2,0.9 -3.10039,2.899609 -2.90039,5.099609 -19.6,8.2 -28.8,30.700781 -20.5,50.300781 8.2,19.599999 30.70078,28.799999 50.30078,20.499999 19.6,-8.2 28.8,-30.70078 20.5,-50.30078 -6,-14.2 -19.90039,-23.4 -35.40039,-23.5 -1.8,0 -3.60039,0.100391 -5.40039,0.400391 -0.825,-1.875 -2.71797,-2.963282 -4.66797,-2.925782 z m 10.61328,4.394532 c 17.66639,0.290194 33.00821,13.40625 35.45508,31.53125 2.8,20 -11.19961,38.399609 -31.09961,41.099609 -1.6,0.2 -3.30039,0.30078 -4.90039,0.30078 -20.1,0 -36.40039,-16.30039 -36.40039,-36.400389 0,-14.6 8.69961,-27.8 22.09961,-33.5 1.4,2.4 4.40078,3.30039 6.80078,1.90039 1.6,-0.9 2.5,-2.50039 2.5,-4.40039 v -0.09961 -0.101562 c 1.86563,-0.253125 3.71737,-0.360099 5.54492,-0.330078 z M 836,78 a 7,7 0 0 0 -7,7 7,7 0 0 0 7,7 7,7 0 0 0 7,-7 7,7 0 0 0 -7,-7 z"
      />
      <rect
        fill="rgba(0,0,0,0)"
        x="740"
        y="0"
        width="170"
        height="170"
        onMouseEnter={handleHover(animateMotionsRef[2])}
      />
      <path fill="black" d="M9.9,83H162v2H9.9a5,5,0,1,1,0-2Z" />
      <rect fill="black" xmlns="http://www.w3.org/2000/svg" x="606.786" y="84" width="131.214" height="2" />
      <rect fill="black" xmlns="http://www.w3.org/2000/svg" x="288" y="84" width="149.437" height="2" />
      <circle cx="206.636" cy="114.671" r="5" fill="#FF7C7E">
        <animateMotion
          ref={animateMotionsRef[0]}
          begin="0s"
          dur="1s"
          repeatCount="1"
          path="m0 0c-15.815 -9.408 -21.009 -29.8559 -11.601 -45.671"
          fill="freeze"
          calcMode="spline"
          keySplines="0,0,.58,1"
          values="0%;100%"
          keyTimes="0;1"
        />
      </circle>
      <ellipse cx="528.314" cy="78" rx="2.5" ry="5" fill="#FF7C7E" transform="rotate(45 528.314 78)">
        <animateMotion
          ref={animateMotionsRef[1][0]}
          to="25"
          begin="1s"
          dur="1.25s"
          repeatCount="1"
          path="m0 0l2 7.293"
          fill="freeze"
          calcMode="spline"
          keySplines="0,0,.58,1"
          values="0%;100%"
          keyTimes="0;1"
        />
      </ellipse>
      <ellipse cx="521.314" cy="78" rx="2.5" ry="5" fill="#FF7C7E" transform="rotate(45 521.314 78)">
        <animateMotion
          ref={animateMotionsRef[1][1]}
          to="25"
          begin="1s"
          dur="1.25s"
          repeatCount="1"
          path="m0 0l3 24.293"
          fill="freeze"
          calcMode="spline"
          keySplines="0,0,.58,1"
          values="0%;100%"
          keyTimes="0;1"
        />
      </ellipse>
      <ellipse cx="508.561" cy="76" rx="2.5" ry="5" fill="#FF7C7E" transform="rotate(-28 508.561 73)">
        <animateMotion
          ref={animateMotionsRef[1][2]}
          to="25"
          begin="1s"
          dur="1.25s"
          repeatCount="1"
          path="m0 0l3 18.5874"
          fill="freeze"
          calcMode="spline"
          keySplines="0,0,.58,1"
          values="0%;100%"
          keyTimes="0;1"
        />
      </ellipse>
      <circle cx="876.5" cy="122.5" r="10" fill="#FF7C7E">
        <animateMotion
          ref={animateMotionsRef[2]}
          to="25"
          begin="2s"
          dur="1s"
          repeatCount="1"
          path="m0 0c-40 39.5 -96.5 6.5 -95.5 -37"
          fill="freeze"
          calcMode="spline"
          keySplines="0,0,.58,1"
          values="0%;100%"
          keyTimes="0;1"
        />
      </circle>
    </svg>
  );
});

export default Diagram;
